<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Mysql 运维相关脚本收集 | 逍客 - Stay Happy and Enjoy Life!</title>
  
  <meta name="keywords" content="旧书, 生活, 微信, 照片, 户外, 钓鱼, 亲子">
  
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="https://choelea.github.io/assets/img/favicon.ico">
  <link rel="alternate" href="/atom.xml" title="逍客 - Stay Happy and Enjoy Life!">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="https://choelea.github.io/assets/img/favicon.ico" type="image/x-icon">
  <link rel="icon" href="https://choelea.github.io/assets/img/favicon.ico" type="image/x-icon">
  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet">
  
  <!-- <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?3fd67b824da2406da99e2941d5c0d062";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>
</html>
<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar" class="pure"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header pure">
	<div class="wrapper">
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/">逍客 - Stay Happy and Enjoy Life!</a>
				<div class="menu">
					<ul class="h-list">
            
    					
    						<li>
    							<a class="nav flat-box" href="https://choelea.github.io/">
    								<i class="fas fa-home fa-fw"></i>&nbsp;主页
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="https://choelea.github.io/projects/">
    								<i class="fas fa-flask fa-fw"></i>&nbsp;项目
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="/">
    								<i class="fas fa-rss fa-fw"></i>&nbsp;博客
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="/archives/">
    								<i class="fas fa-archive fa-fw"></i>&nbsp;归档
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="https://choelea.github.io/about/">
    								<i class="fas fa-user fa-fw"></i>&nbsp;关于
  								</a>
  							</li>
        			
        		
					</ul>
					<div class="underline"></div>
				</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-top"><a class="fas fa-arrow-up fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
		<nav>
      <ul>
          
              
                  <li>
										<a class="nav  flat-box" href="https://choelea.github.io/">
											<i class="fas fa-home fa-fw"></i>&nbsp;主页
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="https://choelea.github.io/projects/">
											<i class="fas fa-flask fa-fw"></i>&nbsp;项目
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="/">
											<i class="fas fa-rss fa-fw"></i>&nbsp;博客
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;归档
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="https://choelea.github.io/about/">
											<i class="fas fa-user fa-fw"></i>&nbsp;关于
										</a>
                  </li>
              
       
      </ul>
		</nav>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            <article id="post-Database-Technologies/Mysql-Administration" class="post white-box article-type-post" itemscope="" itemprop="blogPost">
    <section class="meta">
        
            <h1 class="title">Mysql 运维相关脚本收集</h1>
        
        <time class="time">
            <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
            2018-12-11
        </time>
        
          <div class="browse busuanzi"><i class="fas fa-eye fa-fw" aria-hidden="true"></i>
            <span id="busuanzi_value_page_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          </div>
        

        

    </section>

    <section class="article typo">

        <div class="article-entry" itemprop="articleBody">
            <p>mysql 版本： 5.6</p>
<h1 id="建库及用户"><a href="#建库及用户" class="headerlink" title="建库及用户"></a>建库及用户</h1><p>创建数据库dbname及用户dbuser/dbpassword 并授权数据库全不权限给用户dbuser<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span>  <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`dbname`</span> <span class="comment">/*!40100 DEFAULT CHARACTER SET utf8 COLLATE utf8_bin */</span></span><br><span class="line"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> dbname.* <span class="keyword">to</span> dbuser@localhost <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'dbpassword'</span>;</span><br></pre></td></tr></table></figure></p>
<h1 id="SQL-收集"><a href="#SQL-收集" class="headerlink" title="SQL 收集"></a>SQL 收集</h1><h2 id="找出有记录的表"><a href="#找出有记录的表" class="headerlink" title="找出有记录的表"></a>找出有记录的表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT  * FROM  INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = &apos;okchem&apos; and table_rows &gt; 0;</span><br></pre></td></tr></table></figure>
<h2 id="快速删除树形表数据"><a href="#快速删除树形表数据" class="headerlink" title="快速删除树形表数据"></a>快速删除树形表数据</h2><p>如何快速删除树形比如：ProductCategory 这类模型的数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> okchem.ProductCategory <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">0</span>;  <span class="comment">-- id&gt;0 可以去除错误</span></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>采用where条件<code>where id &gt; 0</code>可以去除如下错误：Error Code: 1175. You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column To disable safe mode, toggle the option in Preferences -&gt; SQL Editor and reconnect.</p>
</blockquote>
<h2 id="快速查询表的依赖"><a href="#快速查询表的依赖" class="headerlink" title="快速查询表的依赖"></a>快速查询表的依赖</h2><p>查询表依赖那些表和查询那些表依赖此表； </p>
<h3 id="查询我依赖的："><a href="#查询我依赖的：" class="headerlink" title="查询我依赖的："></a>查询我依赖的：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT TABLE_NAME,</span><br><span class="line">       COLUMN_NAME,</span><br><span class="line">       CONSTRAINT_NAME,</span><br><span class="line">       REFERENCED_TABLE_NAME,</span><br><span class="line">       REFERENCED_COLUMN_NAME</span><br><span class="line">FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE</span><br><span class="line">WHERE TABLE_SCHEMA = &quot;schemaName&quot; </span><br><span class="line">      AND TABLE_NAME = &quot;TableName&quot; </span><br><span class="line">      AND REFERENCED_COLUMN_NAME IS NOT NULL;</span><br></pre></td></tr></table></figure>
<h3 id="查询依赖‘我的’："><a href="#查询依赖‘我的’：" class="headerlink" title="查询依赖‘我的’："></a>查询依赖‘我的’：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      </span><br><span class="line">SELECT TABLE_NAME,</span><br><span class="line">       COLUMN_NAME,</span><br><span class="line">       CONSTRAINT_NAME,</span><br><span class="line">       REFERENCED_TABLE_NAME,</span><br><span class="line">       REFERENCED_COLUMN_NAME</span><br><span class="line">FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE</span><br><span class="line">WHERE TABLE_SCHEMA = &quot;schemaName&quot; </span><br><span class="line">      AND REFERENCED_TABLE_NAME = &quot;TableName&quot;;</span><br></pre></td></tr></table></figure>
<h2 id="删除重复的行"><a href="#删除重复的行" class="headerlink" title="删除重复的行"></a>删除重复的行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE t1 FROM contacts t1</span><br><span class="line">        INNER JOIN</span><br><span class="line">    contacts t2 </span><br><span class="line">WHERE</span><br><span class="line">    t1.id &lt; t2.id AND t1.email = t2.email;</span><br></pre></td></tr></table></figure>
<p>// 当表的记录太多，这种join很危险， 最好的方式是先查出来重复的email，再加上in的条件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE t1 FROM contacts t1</span><br><span class="line">        INNER JOIN</span><br><span class="line">    contacts t2 </span><br><span class="line">WHERE</span><br><span class="line">    t1.id &lt; t2.id AND t1.email = t2.email and t2.email in (&apos;..&apos;,,,,,,,);</span><br></pre></td></tr></table></figure></p>
<h2 id="使用函数"><a href="#使用函数" class="headerlink" title="使用函数"></a>使用函数</h2><h3 id="为空的时候给默认值"><a href="#为空的时候给默认值" class="headerlink" title="为空的时候给默认值"></a>为空的时候给默认值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select ifnull(p.isActive,0) from product</span><br></pre></td></tr></table></figure>
<h3 id="转换成JSON"><a href="#转换成JSON" class="headerlink" title="转换成JSON"></a>转换成JSON</h3><h2 id="创建Function"><a href="#创建Function" class="headerlink" title="创建Function"></a>创建Function</h2><h3 id="Split-delimited-strings"><a href="#Split-delimited-strings" class="headerlink" title="Split delimited strings"></a>Split delimited strings</h3><p>参考： <a href="https://blog.fedecarg.com/2009/02/22/mysql-split-string-function/" target="_blank" rel="noopener">https://blog.fedecarg.com/2009/02/22/mysql-split-string-function/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE FUNCTION SPLIT_STR(</span><br><span class="line">  x VARCHAR(255),</span><br><span class="line">  delim VARCHAR(12),</span><br><span class="line">  pos INT</span><br><span class="line">)</span><br><span class="line">RETURNS VARCHAR(255)</span><br><span class="line">RETURN REPLACE(SUBSTRING(SUBSTRING_INDEX(x, delim, pos),</span><br><span class="line">       LENGTH(SUBSTRING_INDEX(x, delim, pos -1)) + 1),</span><br><span class="line">       delim, &apos;&apos;);</span><br></pre></td></tr></table></figure>
<h1 id="Mysql-分库备份脚本"><a href="#Mysql-分库备份脚本" class="headerlink" title="Mysql 分库备份脚本"></a>Mysql 分库备份脚本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">#Backup databases into separated files excluding system schemas</span><br><span class="line">BACKUP_FOLDER=/home/okchem/mysqlbackup</span><br><span class="line">MYUSER=user</span><br><span class="line">MYPASS=password</span><br><span class="line">SOCKET=/data/mysql/mysql.sock</span><br><span class="line">MYCMD=&quot;mysql -u$MYUSER -p$MYPASS -S $SOCKET&quot;</span><br><span class="line">MYDUMP=&quot;mysqldump -u$MYUSER -p$MYPASS -S $SOCKET&quot;</span><br><span class="line"></span><br><span class="line">mkdir -p $&#123;BACKUP_FOLDER&#125;</span><br><span class="line"></span><br><span class="line">#for database in `$MYDUMP -e &quot;show databases;&quot;|sed &apos;1,2d&apos;|egrep -v &quot;mysql|schema&quot;`</span><br><span class="line">for database in `$MYCMD -e &quot;show databases;&quot; | egrep -Evi &quot;database|mysql|schema|test&quot;`</span><br><span class="line">do </span><br><span class="line">	$MYDUMP $database &gt;$&#123;BACKUP_FOLDER&#125;/$&#123;database&#125;_$(date +%Y%m%d).sql</span><br><span class="line">    #If compression is needed, use this command: $MYDUMP $database |gzip &gt;/server/backup/$&#123;database&#125;_$(date +$F).sql.gz</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h1 id="Mysql-客户端导出数据"><a href="#Mysql-客户端导出数据" class="headerlink" title="Mysql 客户端导出数据"></a>Mysql 客户端导出数据</h1><p>在mysql 服务端可以很方便的导出到文件，也有灵活的选择。 如果需要导出的文件到其他服务器，不在mysql服务器上。 有两个选择：</p>
<ol>
<li>在mysql 服务器上导出文件，通过sftp上传至目标机器</li>
<li>在目标机器安装mysql 客户端，通过shell 脚本来导出数据 （此篇关注点）</li>
</ol>
<h2 id="验证环境"><a href="#验证环境" class="headerlink" title="验证环境"></a>验证环境</h2><p>Linux 系统：Centos 7</p>
<h2 id="安装Mysql-Client"><a href="#安装Mysql-Client" class="headerlink" title="安装Mysql Client"></a>安装Mysql Client</h2><p>参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/linux-installation-rpm.html" target="_blank" rel="noopener">Installing MySQL on Linux Using RPM Packages from Oracle</a></p>
<h2 id="Shell-脚本"><a href="#Shell-脚本" class="headerlink" title="Shell 脚本"></a>Shell 脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################################################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This script is used to retrieve data from mysql and output it into txt file. Also it will generate md5 file <span class="built_in">which</span> can be used to verify the integrity.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Script will make folder named <span class="string">"YYYYMMDD"</span>, also the file name will follow the pattern A/I&#123;tableName&#125;YYYYMMDD&#123;6 sequence number&#125; such as I0100320170303000001</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############################################################################################################################################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############Global Configuration begins ####################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Root folder <span class="built_in">where</span> the data will be stored</span></span><br><span class="line">BEE_ROOT_GLOBAL=/data/b2bbuyerdata</span><br><span class="line">MYSQL_HOST=192.168.1.90</span><br><span class="line">MYSQL_PORT=3306</span><br><span class="line">MYSQL_USERNAME=username</span><br><span class="line">MYSQL_PASSWD=password</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#############Global Configuration ends ####################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> exportAndMD5Sum querySql tableName. Output the query result into tableNameYYYYMMDD000001.txt and tableNameYYYYMMDD000001.md5</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> .md5 file is used to verify data integrity. </span></span><br><span class="line">exportAndMD5Sum()</span><br><span class="line">&#123;</span><br><span class="line">	if [ "$#" != 2 ];then</span><br><span class="line">		echo  "Usage: exportAndMD5Sum querySql tableName";</span><br><span class="line">		exit;</span><br><span class="line">	fi</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Starting <span class="built_in">export</span> data using mysql <span class="built_in">command</span></span></span><br><span class="line">	SQL=$1;</span><br><span class="line">	tableName=$2;</span><br><span class="line">	TIMESTAMP=`date +%Y%m%d`</span><br><span class="line">	BEE_ROOT=$&#123;BEE_ROOT_GLOBAL&#125;/$&#123;TIMESTAMP&#125;</span><br><span class="line">	</span><br><span class="line">	_tmpFile=$&#123;BEE_ROOT&#125;/$&#123;tableName&#125;$&#123;TIMESTAMP&#125;000001.tmp;</span><br><span class="line">	destFile=$&#123;BEE_ROOT&#125;/$&#123;tableName&#125;$&#123;TIMESTAMP&#125;000001.AVL;</span><br><span class="line">	destMD5File=$&#123;BEE_ROOT&#125;/$&#123;tableName&#125;$&#123;TIMESTAMP&#125;000001.CHK;</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Create Folder</span></span><br><span class="line">	[ ! -d "$BEE_ROOT" ] &amp;&amp;  mkdir "$BEE_ROOT"</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash"> Mysql <span class="built_in">command</span> to output data into file</span></span><br><span class="line">	`mysql -h $&#123;MYSQL_HOST&#125; -p$&#123;MYSQL_PORT&#125; -u $&#123;MYSQL_USERNAME&#125; --password=$&#123;MYSQL_PASSWD&#125; -e "$&#123;SQL&#125;" &gt; "$&#123;_tmpFile&#125;"`</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash"> If not empty(has records) change the file name, otherwise remove it.</span></span><br><span class="line">	if [ -f "$_tmpFile" ] &amp;&amp; [ -s "$_tmpFile" ]</span><br><span class="line">		then</span><br><span class="line">			mv $&#123;_tmpFile&#125; $&#123;destFile&#125;</span><br><span class="line"><span class="meta">			#</span><span class="bash">`md5sum <span class="variable">$&#123;destFile&#125;</span> &gt; <span class="variable">$&#123;destMD5File&#125;</span>`</span></span><br><span class="line">			md5=($(md5sum $&#123;destFile&#125;))</span><br><span class="line">			echo $md5 &gt; $&#123;destMD5File&#125;</span><br><span class="line">		else</span><br><span class="line">			rm $&#123;_tmpFile&#125;	</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line">if [ "$1" = "I" ]; then</span><br><span class="line">	echo "Starting export all data from mysql ............."</span><br><span class="line">	exportAndMD5Sum "SELECT username,country,source,city,email,first_name,last_name,province,status,CAST(is_reveive_email AS UNSIGNED) AS is_reveive_email,created_stamp,last_updated_stamp FROM b2bbuyer.user" "I01001"</span><br><span class="line">	exportAndMD5Sum "select u.username,a.address,a.city,a.company_name,a.country,a.first_name,CAST(a.is_default AS UNSIGNED) AS is_default ,a.last_name,a.province,a.tel_country_code,a.tel_ext,a.tel_no,a.zip_code,a.created_stamp,a.last_updated_stamp from b2bbuyer.user u inner join b2bbuyer.user_delivery_address a where a.user_id=u.id" "I01002"</span><br><span class="line">	exportAndMD5Sum "select u.username,c.email,c.address,c.city,c.company_name,c.contact,c.country,c.fax_country_code,c.fax_ext,c.fax_tel_no,c.main_products,c.province,c.register_no,c.tax_no,c.tel_country_code,c.tel_ext,c.tel_no,c.website from b2bbuyer.user u inner join b2bbuyer.user_company c where c.user_id=u.id" "I01003"</span><br><span class="line">else</span><br><span class="line">	echo "Starting export yesterday's data from mysql ............."</span><br><span class="line">	exportAndMD5Sum "SELECT username,country,source,city,email,first_name,last_name,province,status,CAST(is_reveive_email AS UNSIGNED) AS is_reveive_email,created_stamp,last_updated_stamp FROM b2bbuyer.user where last_updated_stamp &lt; (UNIX_TIMESTAMP(CURDATE())*1000) and last_updated_stamp &gt; ((UNIX_TIMESTAMP(CURDATE())-60*60*24)*1000)" "A01001"</span><br><span class="line">	exportAndMD5Sum "select u.username,a.address,a.city,a.company_name,a.country,a.first_name,CAST(a.is_default AS UNSIGNED) AS is_default ,a.last_name,a.province,a.tel_country_code,a.tel_ext,a.tel_no,a.zip_code,a.created_stamp,a.last_updated_stamp from b2bbuyer.user u inner join b2bbuyer.user_delivery_address a where a.user_id=u.id and a.last_updated_stamp &lt; (UNIX_TIMESTAMP(CURDATE())*1000) and a.last_updated_stamp &gt; ((UNIX_TIMESTAMP(CURDATE())-60*60*24)*1000)" "A01002"</span><br><span class="line">	exportAndMD5Sum "select u.username,c.email,c.address,c.city,c.company_name,c.contact,c.country,c.fax_country_code,c.fax_ext,c.fax_tel_no,c.main_products,c.province,c.register_no,c.tax_no,c.tel_country_code,c.tel_ext,c.tel_no,c.website from b2bbuyer.user u inner join b2bbuyer.user_company c where c.user_id=u.id and c.last_updated_stamp &lt; (UNIX_TIMESTAMP(CURDATE())*1000) and c.last_updated_stamp &gt; ((UNIX_TIMESTAMP(CURDATE())-60*60*24)*1000)" "A01003"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<h2 id="添加cron-job"><a href="#添加cron-job" class="headerlink" title="添加cron job"></a>添加cron job</h2><p>参考cronjob <code>crontab -l</code><br>编辑cronjob <code>crontab -e</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0 1 * * * /data/scripts/mysql-job.sh A</span><br><span class="line">20 1 * * 0 /data/scripts/mysql-job.sh I</span><br></pre></td></tr></table></figure>
<p>两个cron job 分别：</p>
<ol>
<li>每天1点执行</li>
<li>每周日1点20 执行</li>
</ol>
<p>参考：crontab 时间可以参考： <a href="https://www.cnblogs.com/intval/p/5763929.html" target="_blank" rel="noopener">https://www.cnblogs.com/intval/p/5763929.html</a></p>
<h1 id="Mysql-客户端导入数据"><a href="#Mysql-客户端导入数据" class="headerlink" title="Mysql 客户端导入数据"></a>Mysql 客户端导入数据</h1><h2 id="从txt文件导入"><a href="#从txt文件导入" class="headerlink" title="从txt文件导入"></a>从txt文件导入</h2><p>参考： <a href="https://blog.csdn.net/huihui520com/article/details/79080512" target="_blank" rel="noopener">https://blog.csdn.net/huihui520com/article/details/79080512</a></p>
<p><a href="https://segmentfault.com/a/1190000009333563" target="_blank" rel="noopener">https://segmentfault.com/a/1190000009333563</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use test;</span><br><span class="line">load data infile &apos;D:/tmp/hotwords.txt&apos; into table hot fields terminated by &apos;,&apos; lines terminated by&apos;\r\n&apos;;</span><br><span class="line">ALTER TABLE okchem.hot ADD `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY;</span><br></pre></td></tr></table></figure>
<p>需要解决问题：–secure-file-priv option so it cannot execute this statement<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">windows下：修改my.ini 在[mysqld]内加入secure_file_priv =</span><br><span class="line"></span><br><span class="line">linux下：修改my.cnf 在[mysqld]内加入secure_file_priv =</span><br></pre></td></tr></table></figure></p>
<h1 id="mysql-数据迁移"><a href="#mysql-数据迁移" class="headerlink" title="mysql 数据迁移"></a>mysql 数据迁移</h1><h2 id="自增字段问题"><a href="#自增字段问题" class="headerlink" title="自增字段问题"></a>自增字段问题</h2><p>新增表格，需要将旧的数据迁入新表。Mysql的自增字段默认行为：</p>
<ol>
<li>取最大的(比如： 创建表后，只插入一条数据， ID直接指定为9， 那么下一条插入的数据在不指定ID值的情况下，ID是10）</li>
<li>删除数据后，ID的起点不会因为删除而改变。 （插入N条数据，假如这N条都是未指定ID的插入，也就是说下一个ID是N+1， 这个时候删除所有的数据，再以不指定ID的方式插入一条数据，这个时候ID是<strong>N+1</strong>）<h1 id="Mysql-系统变量配置"><a href="#Mysql-系统变量配置" class="headerlink" title="Mysql 系统变量配置"></a>Mysql 系统变量配置</h1><h2 id="windows-下安装的mysql的配置文件地址"><a href="#windows-下安装的mysql的配置文件地址" class="headerlink" title="windows 下安装的mysql的配置文件地址"></a>windows 下安装的mysql的配置文件地址</h2>从服务列表<code>services.msc</code> 中找到mysql的服务，右键查看属性中的“可执行文件路径”。参考：<br><a href="https://blog.csdn.net/postnull/article/details/72455768" target="_blank" rel="noopener">https://blog.csdn.net/postnull/article/details/72455768</a><h2 id="Win-7-设置表明区分大小写"><a href="#Win-7-设置表明区分大小写" class="headerlink" title="Win 7 设置表明区分大小写"></a>Win 7 设置表明区分大小写</h2>参考： <a href="https://blog.csdn.net/postnull/article/details/72455768" target="_blank" rel="noopener">https://blog.csdn.net/postnull/article/details/72455768</a><br>在my.ini 文件中添加 <code>lower_case_table_names=2</code> </li>
</ol>

        </div>

        <section class="meta">
            <time class="time" itemprop="dateUpdated" datetime="2018-12-11T22:14:40+08:00" content="2018-12-11">
                <i class="fas fa-pen fa-fw" aria-hidden="true"></i>
                本文最后更新于：2018-12-11
            </time>
            
                
                <div class="tags">
                    <i class="fas fa-tags fa-fw" aria-hidden="true"></i>
                    <a class="tag" href="/tags/Mysql/">Mysql</a>, <a class="tag" href="/tags/运维/">运维</a>, <a class="tag" href="/tags/数据库/">数据库</a>
                </div>
            
        </section>

        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一篇</h6>
                            <h4>
                                <a href="/Dev-Ops/Git-Commands/" rel="prev" title="Git 常用命令">
                                  
                                      Git 常用命令
                                  
                                </a>
                            </h4>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一篇&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/Database-Technologies/mongodb-command/" rel="prev" title="MongoDB 命令 常用语句">
                                    
                                        MongoDB 命令 常用语句
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <i class="fas fa-tags fa-fw" aria-hidden="true"></i>
                                    <a class="tag" href="/tags/Mysql/">Mysql</a>, <a class="tag" href="/tags/Mongo/">Mongo</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        

    </section>

</article>

<br>

<!-- 显示推荐文章和评论 -->

    <article class="post white-box comments">
        <section class="article typo">

            
                

    <div class="recommended_posts">
        <h4><i class="fas fa-bookmark fa-fw" aria-hidden="true"></i>&nbsp;你可能感兴趣的文章</h4>
        <ul>
            
                <li><a href="https://choelea.github.io/Dev-Ops/Centos-Common-Commands/">Centos 常用命令</a></li>
            
                <li><a href="https://choelea.github.io/Dev-Ops/Git-Commands/">Git 常用命令</a></li>
            
                <li><a href="https://choelea.github.io/Database-Technologies/mongodb-command/">MongoDB 命令 常用语句</a></li>
            
                <li><a href="https://choelea.github.io/Database-Technologies/Mongodb-vs-Mysql-basic/">Mongodb 和 Mysql 的性能测试</a></li>
            
        </ul>
    </div>


            

            

                

                

                
                    
                        <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;Valine评论</h4>
                        <div class="subtitle">
                          <h6><b>文明评论，请勿灌水。</b>为了便于区分和接收回复提醒，请您在留言时填写一下<b>昵称</b>和<b>邮箱</b>。
                          不定期清理没有昵称和灌水的评论。</h6>
                        <div>
                        <section id="comments">
                            <div id="valine_container" class="valine_thread">
                                <i class="fas fa-spinner fa-spin fa-fw"></i>
                            </div>
                        </section>
                        <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
                        <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
                    
                
            

        </div></div></section>
    </article>


<script>
    window.subData = {
        title: 'Mysql 运维相关脚本收集',
        tools: true
    }
</script>


        </div>
        <aside class='l_side'>
            
    
        
  <section class="m_widget author">
    
      <div class="header">
        <img class="avatar" src="https://choelea.github.io/assets/img/avatar.jpg">
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="mailto:joe.lea@foxmail.com" class="social flat-box" target="_blank" rel="external"><i class="social fas fa-envelope" aria-hidden="true"></i></a>
          
        
          
            <a href="https://github.com/choelea" class="social flat-box" target="_blank" rel="external"><i class="social fab fa-github" aria-hidden="true"></i></a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=781987646" class="social flat-box" target="_blank" rel="external"><i class="social fas fa-music" aria-hidden="true"></i></a>
          
        
      </div>
    
  </section>


    
    
        
  <section class="m_widget announcement">
    <header class="header pure">
        <div><i class="fas fa-bullhorn fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;公告</div>
    </header>
    <div class="content pure">
      本站使用 <b><a href="https://choelea.github.io/wiki/material-x/">Material X</a></b> 作为主题，喜欢这个主题的朋友可以阅读文档进行安装哦。
    </div>
  </section>


    
    
        <section class="m_widget categories">
    <header class="header pure">
        <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;分类</div>
    </header>
    <div class="content pure">
        
    </div>
</section>

    
    
        
    <section class="m_widget tagcloud">
        <header class="header pure">
            <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;标签</div>
        </header>
        <div class="content pure">
            <a href="/tags/Mongo/" style="font-size: 14px; color: #999">Mongo</a> <a href="/tags/Mysql/" style="font-size: 24px; color: #555">Mysql</a> <a href="/tags/数据库/" style="font-size: 14px; color: #999">数据库</a> <a href="/tags/运维/" style="font-size: 14px; color: #999">运维</a>
        </div>
    </section>


    
    
        
    <section class="m_widget toc-wrapper">
        <header class="header pure">
            <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;目录</div>
            <div class="wrapper"><a class="s-toc rightBtn" title="固定到顶部" target="_blank" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
        </header>
        <div class="content pure">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#建库及用户"><span class="toc-text">建库及用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SQL-收集"><span class="toc-text">SQL 收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#找出有记录的表"><span class="toc-text">找出有记录的表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#快速删除树形表数据"><span class="toc-text">快速删除树形表数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#快速查询表的依赖"><span class="toc-text">快速查询表的依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询我依赖的："><span class="toc-text">查询我依赖的：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询依赖‘我的’："><span class="toc-text">查询依赖‘我的’：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#删除重复的行"><span class="toc-text">删除重复的行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用函数"><span class="toc-text">使用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为空的时候给默认值"><span class="toc-text">为空的时候给默认值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转换成JSON"><span class="toc-text">转换成JSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建Function"><span class="toc-text">创建Function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Split-delimited-strings"><span class="toc-text">Split delimited strings</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql-分库备份脚本"><span class="toc-text">Mysql 分库备份脚本</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql-客户端导出数据"><span class="toc-text">Mysql 客户端导出数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#验证环境"><span class="toc-text">验证环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装Mysql-Client"><span class="toc-text">安装Mysql Client</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shell-脚本"><span class="toc-text">Shell 脚本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加cron-job"><span class="toc-text">添加cron job</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql-客户端导入数据"><span class="toc-text">Mysql 客户端导入数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#从txt文件导入"><span class="toc-text">从txt文件导入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql-数据迁移"><span class="toc-text">mysql 数据迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#自增字段问题"><span class="toc-text">自增字段问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql-系统变量配置"><span class="toc-text">Mysql 系统变量配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-下安装的mysql的配置文件地址"><span class="toc-text">windows 下安装的mysql的配置文件地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Win-7-设置表明区分大小写"><span class="toc-text">Win 7 设置表明区分大小写</span></a></li></ol></li></ol>
        </div>
    </section>


    
    
        <section class="m_widget music">
    <header class="header pure">
        <div><i class="fas fa-headphones-alt fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;音乐</div>
        <a class="rightBtn" title="打开博主的网易云音乐主页" target="_blank" rel="external nofollow noopener noreferrer" href="https://music.163.com/#/playlist?id=781987646"><i class="fas fa-external-link-square-alt fa-fw"></i></a>
    </header>
    <div class="content pure">
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="450" src="//music.163.com/outchain/player?type=0&id=781987646&auto=0&height=450"></iframe>
    </div>
</section>

    
    
        <section class="m_widget links">
    <header class="header pure">
        <div><i class="fas fa-handshake fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;友链</div>
        
            <a class="rightBtn" title="联系博主添加友链" target="_blank" rel="external nofollow noopener noreferrer" href="mailto:joe.lea@foxmail.com?subject=交换友链&body=你好，我想和你交换友链，我已经将【逍客 - Stay Happy and Enjoy Life!】添加到我的博客的友链中。我的博客链接是："><i class="fas fa-plus fa-fw"></i></a>
        
    </header>
    <div class="content pure">
        <ul class="entry" id="links">
            
                <li><a class="flat-box" title="https://choelea.github.io/blog" target="_blank" rel="external nofollow noopener noreferrer" href="https://choelea.github.io/blog">
                    <div class="name">
                        
                            <img src="https://choelea.github.io/assets/img/avatar.jpg">
                        
                        &nbsp;&nbsp;xaoxuu&#39;s blog
                    </div>
                </a></li>
            
        </ul>
    </div>
</section>

    


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    </div>
    <footer id="footer" class="clearfix">
    
        <div class="social-wrapper">
          
              
                  <a href="mailto:joe.lea@foxmail.com" class="social fas fa-envelope flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="https://github.com/choelea" class="social fab fa-github flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="https://music.163.com/#/user/home?id=781987646" class="social fas fa-music flat-box" target="_blank" rel="external"></a>
              
          
        </div>
    
    <br>
    <div>博客内容遵循 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="licenses">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div>
    <div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> 作为主题，
		总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
    </div>
</footer>
<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->


    <script>setLoadingBarProgress(80);</script>
    <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<!-- 访问统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/jquery.fitvids.js"></script>

    <script>
        var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
        var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
        var ALGOLIA_API_KEY = "";
        var ALGOLIA_APP_ID = "";
        var ALGOLIA_INDEX_NAME = "";
        var AZURE_SERVICE_NAME = "";
        var AZURE_INDEX_NAME = "";
        var AZURE_QUERY_KEY = "";
        var BAIDU_API_ID = "";
        var SEARCH_SERVICE = "hexo" || "hexo";
        var ROOT = "/"||"/";
        if(!ROOT.endsWith('/'))ROOT += '/';
    </script>

<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


    
    
    
        
            <script>
            var GUEST_INFO = ['nick','mail','link'];
            var guest_info = 'nick,mail,link'.split(',').filter(function(item){
                return GUEST_INFO.indexOf(item) > -1
            });
            var notify = 'false' == true;
            var verify = 'false' == true;
            var valine = new Valine();
            valine.init({
                el: '#valine_container',
                notify: notify,
                verify: verify,
                guest_info: guest_info,
                appId: "HnFN3camhSX52IMir3lqT3hM-gzGzoHsz",
                appKey: "vJsgB1TGKlmniiQsWp51HJaJ",
                placeholder: "快来评论吧~",
                pageSize:'10',
                avatar:'mp',
                lang:'zh-cn',
                highlight:''
            })
            </script>
        
    




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>
    AV.initialize("HnFN3camhSX52IMir3lqT3hM-gzGzoHsz", "vJsgB1TGKlmniiQsWp51HJaJ"); 
  </script>
  <script>
  function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function () {
      entries.push( $(this).attr("id").trim() );
    });

    query.containedIn('url', entries);
    query.find()
      .done(function (results) {
        var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

        if (results.length === 0) {
          $visitors.find(COUNT_CONTAINER_REF).text(0);
          return;
        }

        for (var i = 0; i < results.length; i++) {
          var item = results[i];
          var url = item.get('url');
          var time = item.get('time');
          var element = document.getElementById(url);

          $(element).find(COUNT_CONTAINER_REF).text(time);
        }
        for(var i = 0; i < entries.length; i++) {
          var url = entries[i];
          var element = document.getElementById(url);
          var countSpan = $(element).find(COUNT_CONTAINER_REF);
          if( countSpan.text() == '') {
            countSpan.text(0);
          }
        }
      })
      .fail(function (object, error) {
        console.log("Error: " + error.code + " " + error.message);
      });
  }

  function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
      success: function(results) {
        if (results.length > 0) {
          var counter = results[0];
          counter.fetchWhenSave(true);
          counter.increment("time");
          counter.save(null, {
            success: function(counter) {
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.get('time'));
            },
            error: function(counter, error) {
              console.log('Failed to save Visitor num, with error message: ' + error.message);
            }
          });
        } else {
          var newcounter = new Counter();
          /* Set ACL */
          var acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          newcounter.setACL(acl);
          /* End Set ACL */
          newcounter.set("title", title);
          newcounter.set("url", url);
          newcounter.set("time", 1);
          newcounter.save(null, {
            success: function(newcounter) {
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
            },
            error: function(newcounter, error) {
              console.log('Failed to create');
            }
          });
        }
      },
      error: function(error) {
        console.log('Error:' + error.code + " " + error.message);
      }
    });
  }

  $(function() {
    var Counter = AV.Object.extend("Counter");
    if ($('.leancloud_visitors').length == 1) {
      addCount(Counter);
    } else if ($('.post-title-link').length > 1) {
      showTime(Counter);
    }
  });
</script>


    <script>setLoadingBarProgress(100);</script>
</body>
